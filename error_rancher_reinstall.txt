PLAY [Cluster prep] *************************************************************************************************************************************************************************

TASK [Gathering Facts] **********************************************************************************************************************************************************************
[WARNING]: Platform linux on host 160.85.30.104 is using the discovered Python interpreter at /usr/bin/python3.10, but future installation of another Python interpreter could change the
meaning of that path. See https://docs.ansible.com/ansible-core/2.17/reference_appendices/interpreter_discovery.html for more information.
ok: [160.85.30.104]
[WARNING]: Platform linux on host 160.85.30.105 is using the discovered Python interpreter at /usr/bin/python3.10, but future installation of another Python interpreter could change the
meaning of that path. See https://docs.ansible.com/ansible-core/2.17/reference_appendices/interpreter_discovery.html for more information.
ok: [160.85.30.105]

TASK [prereq : Enforce minimum Ansible version] *********************************************************************************************************************************************
ok: [160.85.30.104] => {
    "changed": false,
    "msg": "All assertions passed"
}
ok: [160.85.30.105] => {
    "changed": false,
    "msg": "All assertions passed"
}

TASK [prereq : Install Dependent Ubuntu Packages] *******************************************************************************************************************************************
ok: [160.85.30.104]
ok: [160.85.30.105]

TASK [prereq : Enable IPv4 forwarding] ******************************************************************************************************************************************************
ok: [160.85.30.104]
ok: [160.85.30.105]

TASK [prereq : Enable IPv6 forwarding] ******************************************************************************************************************************************************
ok: [160.85.30.104]
ok: [160.85.30.105]

TASK [prereq : Populate service facts] ******************************************************************************************************************************************************
ok: [160.85.30.104]
ok: [160.85.30.105]

TASK [prereq : Get ufw status] **************************************************************************************************************************************************************
ok: [160.85.30.105]
ok: [160.85.30.104]

TASK [prereq : If ufw enabled, open api port] ***********************************************************************************************************************************************
skipping: [160.85.30.104]
skipping: [160.85.30.105]

TASK [prereq : If ufw enabled, open etcd ports] *********************************************************************************************************************************************
skipping: [160.85.30.104]
skipping: [160.85.30.105]

TASK [prereq : If ufw enabled, allow default CIDRs] *****************************************************************************************************************************************
skipping: [160.85.30.104] => (item=10.42.0.0/16) 
skipping: [160.85.30.104] => (item=10.43.0.0/16) 
skipping: [160.85.30.104]
skipping: [160.85.30.105] => (item=10.42.0.0/16) 
skipping: [160.85.30.105] => (item=10.43.0.0/16) 
skipping: [160.85.30.105]

TASK [prereq : If firewalld enabled, open api port] *****************************************************************************************************************************************
skipping: [160.85.30.104]
skipping: [160.85.30.105]

TASK [prereq : If firewalld enabled, open etcd ports] ***************************************************************************************************************************************
skipping: [160.85.30.104]
skipping: [160.85.30.105]

TASK [prereq : If firewalld enabled, open inter-node ports] *********************************************************************************************************************************
skipping: [160.85.30.104] => (item=5001/tcp) 
skipping: [160.85.30.104] => (item=8472/udp) 
skipping: [160.85.30.104] => (item=10250/tcp) 
skipping: [160.85.30.105] => (item=5001/tcp) 
skipping: [160.85.30.104] => (item=51820/udp) 
skipping: [160.85.30.105] => (item=8472/udp) 
skipping: [160.85.30.104] => (item=51821/udp) 
skipping: [160.85.30.104]
skipping: [160.85.30.105] => (item=10250/tcp) 
skipping: [160.85.30.105] => (item=51820/udp) 
skipping: [160.85.30.105] => (item=51821/udp) 
skipping: [160.85.30.105]

TASK [prereq : If firewalld enabled, allow node CIDRs] **************************************************************************************************************************************
skipping: [160.85.30.104] => (item=160.85.30.104) 
skipping: [160.85.30.104] => (item=160.85.30.105) 
skipping: [160.85.30.104]
skipping: [160.85.30.105] => (item=160.85.30.104) 
skipping: [160.85.30.105] => (item=160.85.30.105) 
skipping: [160.85.30.105]

TASK [prereq : If firewalld enabled, allow default CIDRs] ***********************************************************************************************************************************
skipping: [160.85.30.104] => (item=10.42.0.0/16) 
skipping: [160.85.30.104] => (item=10.43.0.0/16) 
skipping: [160.85.30.104]
skipping: [160.85.30.105] => (item=10.42.0.0/16) 
skipping: [160.85.30.105] => (item=10.43.0.0/16) 
skipping: [160.85.30.105]

TASK [prereq : Add br_netfilter to /etc/modules-load.d/] ************************************************************************************************************************************
skipping: [160.85.30.104]
skipping: [160.85.30.105]

TASK [prereq : Load br_netfilter] ***********************************************************************************************************************************************************
skipping: [160.85.30.104]
skipping: [160.85.30.105]

TASK [prereq : Set bridge-nf-call-iptables (just to be sure)] *******************************************************************************************************************************
skipping: [160.85.30.104] => (item=net.bridge.bridge-nf-call-iptables) 
skipping: [160.85.30.104] => (item=net.bridge.bridge-nf-call-ip6tables) 
skipping: [160.85.30.104]
skipping: [160.85.30.105] => (item=net.bridge.bridge-nf-call-iptables) 
skipping: [160.85.30.105] => (item=net.bridge.bridge-nf-call-ip6tables) 
skipping: [160.85.30.105]

TASK [prereq : Check for Apparmor existence] ************************************************************************************************************************************************
ok: [160.85.30.104]
ok: [160.85.30.105]

TASK [prereq : Check if Apparmor is enabled] ************************************************************************************************************************************************
ok: [160.85.30.104]
ok: [160.85.30.105]

TASK [prereq : Install Apparmor Parser [Suse]] **********************************************************************************************************************************************
skipping: [160.85.30.104]
skipping: [160.85.30.105]

TASK [prereq : Install Apparmor Parser [Debian]] ********************************************************************************************************************************************
skipping: [160.85.30.104]
skipping: [160.85.30.105]

TASK [prereq : Gather the package facts] ****************************************************************************************************************************************************
ok: [160.85.30.104]
ok: [160.85.30.105]

TASK [prereq : If iptables v1.8.0-1.8.4, warn user] *****************************************************************************************************************************************
skipping: [160.85.30.104]
skipping: [160.85.30.105]

TASK [prereq : Add /usr/local/bin to sudo secure_path] **************************************************************************************************************************************
skipping: [160.85.30.104]
skipping: [160.85.30.105]

TASK [prereq : Make rancher directory] ******************************************************************************************************************************************************
skipping: [160.85.30.104]
skipping: [160.85.30.105]

TASK [prereq : Create symlink] **************************************************************************************************************************************************************
skipping: [160.85.30.104]
skipping: [160.85.30.105]

TASK [prereq : Make manifests directory] ****************************************************************************************************************************************************
skipping: [160.85.30.104]
skipping: [160.85.30.105]

TASK [prereq : Copy manifests] **************************************************************************************************************************************************************
skipping: [160.85.30.104]
skipping: [160.85.30.105]

TASK [prereq : Make k3s config directory] ***************************************************************************************************************************************************
skipping: [160.85.30.104]
skipping: [160.85.30.105]

TASK [prereq : Copy config values] **********************************************************************************************************************************************************
skipping: [160.85.30.104]
skipping: [160.85.30.105]

TASK [airgap : Verify Ansible meets airgap version requirements.] ***************************************************************************************************************************
skipping: [160.85.30.104]
skipping: [160.85.30.105]

TASK [airgap : Check for existing install script] *******************************************************************************************************************************************
skipping: [160.85.30.104]
skipping: [160.85.30.105]

TASK [airgap : Download k3s install script] *************************************************************************************************************************************************
skipping: [160.85.30.104]
skipping: [160.85.30.105]

TASK [airgap : Distribute K3s install script] ***********************************************************************************************************************************************
skipping: [160.85.30.104]
skipping: [160.85.30.105]

TASK [airgap : Determine architecture and set k3s_arch] *************************************************************************************************************************************
skipping: [160.85.30.104]
skipping: [160.85.30.105]

TASK [airgap : Distribute K3s binary {{ k3s_arch }}] ****************************************************************************************************************************************
skipping: [160.85.30.104]
skipping: [160.85.30.105]

TASK [airgap : Distribute K3s SELinux RPM] **************************************************************************************************************************************************
skipping: [160.85.30.104]
skipping: [160.85.30.105]

TASK [airgap : Install K3s SELinux RPM] *****************************************************************************************************************************************************
skipping: [160.85.30.104]
skipping: [160.85.30.105]

TASK [airgap : Make images directory] *******************************************************************************************************************************************************
skipping: [160.85.30.104]
skipping: [160.85.30.105]

TASK [airgap : Distribute K3s images {{ k3s_arch }}] ****************************************************************************************************************************************
skipping: [160.85.30.104]
skipping: [160.85.30.105]

TASK [airgap : Run K3s Install [server]] ****************************************************************************************************************************************************
skipping: [160.85.30.104]
skipping: [160.85.30.105]

TASK [airgap : Run K3s Install [agent]] *****************************************************************************************************************************************************
skipping: [160.85.30.104]
skipping: [160.85.30.105]

TASK [raspberrypi : Test for raspberry pi /proc/cpuinfo] ************************************************************************************************************************************
ok: [160.85.30.104]
ok: [160.85.30.105]

TASK [raspberrypi : Test for raspberry pi /proc/device-tree/model] **************************************************************************************************************************
ok: [160.85.30.104]
ok: [160.85.30.105]

TASK [raspberrypi : Set raspberry_pi fact to true] ******************************************************************************************************************************************
skipping: [160.85.30.104]
skipping: [160.85.30.105]

TASK [raspberrypi : Set detected_distribution to Raspbian] **********************************************************************************************************************************
skipping: [160.85.30.104]
skipping: [160.85.30.105]

TASK [raspberrypi : Set detected_distribution to Debian] ************************************************************************************************************************************
skipping: [160.85.30.104]
skipping: [160.85.30.105]

TASK [raspberrypi : Set detected_distribution to ArchLinux (ARM64)] *************************************************************************************************************************
skipping: [160.85.30.104]
skipping: [160.85.30.105]

TASK [raspberrypi : Execute OS related tasks on the Raspberry Pi] ***************************************************************************************************************************
skipping: [160.85.30.104] => (item=/home/caspar/Documents/git/k3s-ansible/roles/raspberrypi/tasks/prereq/Ubuntu.yml) 
skipping: [160.85.30.104]
skipping: [160.85.30.105] => (item=/home/caspar/Documents/git/k3s-ansible/roles/raspberrypi/tasks/prereq/Ubuntu.yml) 
skipping: [160.85.30.105]

PLAY [Setup K3S server] *********************************************************************************************************************************************************************

TASK [Gathering Facts] **********************************************************************************************************************************************************************
ok: [160.85.30.104]

TASK [k3s_server : Get k3s installed version] ***********************************************************************************************************************************************
ok: [160.85.30.104]

TASK [k3s_server : Set k3s installed version] ***********************************************************************************************************************************************
ok: [160.85.30.104]

TASK [k3s_server : Download K3s install script] *********************************************************************************************************************************************
skipping: [160.85.30.104]

TASK [k3s_server : Download K3s binary] *****************************************************************************************************************************************************
skipping: [160.85.30.104]

TASK [k3s_server : Add K3s autocomplete to user bashrc] *************************************************************************************************************************************
ok: [160.85.30.104]

TASK [k3s_server : Make config directory] ***************************************************************************************************************************************************
skipping: [160.85.30.104]

TASK [k3s_server : Copy config values] ******************************************************************************************************************************************************
skipping: [160.85.30.104]

TASK [k3s_server : Copy K3s service file [Single]] ******************************************************************************************************************************************
ok: [160.85.30.104]

TASK [k3s_server : Copy K3s service file [HA]] **********************************************************************************************************************************************
skipping: [160.85.30.104]

TASK [k3s_server : Add service environment variables] ***************************************************************************************************************************************
skipping: [160.85.30.104]

TASK [k3s_server : Delete any existing token from the environment if different from the new one] ********************************************************************************************
ok: [160.85.30.104]

TASK [k3s_server : Add token as an environment variable] ************************************************************************************************************************************
ok: [160.85.30.104]

TASK [k3s_server : Restart K3s service] *****************************************************************************************************************************************************
skipping: [160.85.30.104]

TASK [k3s_server : Enable and check K3s service] ********************************************************************************************************************************************
skipping: [160.85.30.104]

TASK [k3s_server : Pause to allow first server startup] *************************************************************************************************************************************
skipping: [160.85.30.104]

TASK [k3s_server : Check whether kubectl is installed on control node] **********************************************************************************************************************
ok: [160.85.30.104 -> 127.0.0.1]

TASK [k3s_server : Copy k3s.yaml to second file] ********************************************************************************************************************************************
ok: [160.85.30.104]

TASK [k3s_server : Copy kubeconfig to control node] *****************************************************************************************************************************************
skipping: [160.85.30.104]

TASK [k3s_server : Change server address in kubeconfig on control node] *********************************************************************************************************************
skipping: [160.85.30.104]

TASK [k3s_server : Setup kubeconfig context on control node - k3s-ansible] ******************************************************************************************************************
skipping: [160.85.30.104]

TASK [k3s_server : Merge with any existing kubeconfig on control node] **********************************************************************************************************************
skipping: [160.85.30.104]

TASK [k3s_server : Delete any existing token from the environment if different from the new one] ********************************************************************************************
skipping: [160.85.30.104]

TASK [k3s_server : Add the token for joining the cluster to the environment] ****************************************************************************************************************
skipping: [160.85.30.104] => (item=None) 
skipping: [160.85.30.104]

TASK [k3s_server : Copy K3s service file [HA]] **********************************************************************************************************************************************
skipping: [160.85.30.104]

TASK [k3s_server : Copy K3s service file [External DB]] *************************************************************************************************************************************
skipping: [160.85.30.104]

TASK [k3s_server : Restart K3s service] *****************************************************************************************************************************************************
skipping: [160.85.30.104]

TASK [k3s_server : Enable and check K3s service] ********************************************************************************************************************************************
skipping: [160.85.30.104]

TASK [k3s_server : Verify that all server nodes joined] *************************************************************************************************************************************
skipping: [160.85.30.104]

TASK [k3s_server : Create kubectl symlink] **************************************************************************************************************************************************
skipping: [160.85.30.104]

TASK [k3s_server : Create directory .kube] **************************************************************************************************************************************************
ok: [160.85.30.104]

TASK [k3s_server : Copy config file to user home directory] *********************************************************************************************************************************
ok: [160.85.30.104]

TASK [k3s_server : Configure default KUBECONFIG for user] ***********************************************************************************************************************************
ok: [160.85.30.104]

TASK [k3s_server : Configure kubectl autocomplete] ******************************************************************************************************************************************
ok: [160.85.30.104]

PLAY [Setup K3S agent] **********************************************************************************************************************************************************************

TASK [Gathering Facts] **********************************************************************************************************************************************************************
ok: [160.85.30.105]

TASK [k3s_agent : Get k3s installed version] ************************************************************************************************************************************************
ok: [160.85.30.105]

TASK [k3s_agent : Set k3s installed version] ************************************************************************************************************************************************
ok: [160.85.30.105]

TASK [k3s_agent : Download K3s install script] **********************************************************************************************************************************************
skipping: [160.85.30.105]

TASK [k3s_agent : Download K3s binary] ******************************************************************************************************************************************************
skipping: [160.85.30.105]

TASK [k3s_agent : Delete any existing token from the environment if different from the new one] *********************************************************************************************
ok: [160.85.30.105]

TASK [k3s_agent : Add the token for joining the cluster to the environment] *****************************************************************************************************************
ok: [160.85.30.105] => (item=None)
ok: [160.85.30.105]

TASK [k3s_agent : Copy K3s service file] ****************************************************************************************************************************************************
ok: [160.85.30.105]

TASK [k3s_agent : Enable and check K3s service] *********************************************************************************************************************************************
ok: [160.85.30.105]

PLAY [Install and configure Rancher (only on master nodes)] *********************************************************************************************************************************

TASK [Gathering Facts] **********************************************************************************************************************************************************************
ok: [160.85.30.104]

TASK [Ensure Helm is installed] *************************************************************************************************************************************************************
ok: [160.85.30.104]

TASK [Add Rancher repository and update Helm] ***********************************************************************************************************************************************
changed: [160.85.30.104]

TASK [Check if Rancher release exists] ******************************************************************************************************************************************************
fatal: [160.85.30.104]: FAILED! => {"changed": true, "cmd": "helm list -n cattle-system | grep -w '^rancher'", "delta": "0:00:00.070789", "end": "2024-11-06 15:41:56.743851", "msg": "non-zero return code", "rc": 1, "start": "2024-11-06 15:41:56.673062", "stderr": "Error: Kubernetes cluster unreachable: Get \"http://localhost:8080/version\": dial tcp 127.0.0.1:8080: connect: connection refused", "stderr_lines": ["Error: Kubernetes cluster unreachable: Get \"http://localhost:8080/version\": dial tcp 127.0.0.1:8080: connect: connection refused"], "stdout": "", "stdout_lines": []}
...ignoring

TASK [Uninstall existing Rancher release if found] ******************************************************************************************************************************************
skipping: [160.85.30.104]

TASK [Delete cattle-system namespace if still present] **************************************************************************************************************************************
skipping: [160.85.30.104]

TASK [Wait for cattle-system namespace to be fully deleted] *********************************************************************************************************************************
skipping: [160.85.30.104]

TASK [Create cattle-system namespace] *******************************************************************************************************************************************************
fatal: [160.85.30.104]: FAILED! => {"changed": true, "cmd": ["kubectl", "create", "namespace", "cattle-system"], "delta": "0:00:00.188285", "end": "2024-11-06 15:41:57.426025", "msg": "non-zero return code", "rc": 1, "start": "2024-11-06 15:41:57.237740", "stderr": "Error from server (AlreadyExists): namespaces \"cattle-system\" already exists", "stderr_lines": ["Error from server (AlreadyExists): namespaces \"cattle-system\" already exists"], "stdout": "", "stdout_lines": []}
...ignoring

TASK [Install cert-manager] *****************************************************************************************************************************************************************
changed: [160.85.30.104]

TASK [Wait for cert-manager to be running] **************************************************************************************************************************************************
changed: [160.85.30.104]

TASK [Install Rancher using Helm] ***********************************************************************************************************************************************************
changed: [160.85.30.104]

TASK [Verify Rancher deployment status] *****************************************************************************************************************************************************
FAILED - RETRYING: [160.85.30.104]: Verify Rancher deployment status (5 retries left).
changed: [160.85.30.104]

PLAY RECAP **********************************************************************************************************************************************************************************
160.85.30.104              : ok=34   changed=7    unreachable=0    failed=0    skipped=62   rescued=0    ignored=2   
160.85.30.105              : ok=19   changed=0    unreachable=0    failed=0    skipped=40   rescued=0    ignored=0   
